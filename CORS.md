# Cross-origin resource sharing(CORS)
## Описание уязвимости
Политика единого источника (SOP) — это концепция безопасности, реализуемая браузерами для ограничения доступа кода JavaScript из одного домена к ресурсам из других доменов.
Эта концепция безопасности предотвращает доступ вредоносных веб-страниц к ресурсам, доступным пользователю на других веб-страницах.
С введением HTML5 и требованием выполнять междоменные запросы была введена политика совместного использования ресурсов между источниками (CORS).
С помощью этой политики можно определить исключения из SOP и разрешить (доверенным) доменам получать доступ к ресурсам из других доменов через JavaScript.
Чрезмерно разрешающая политика CORS аннулирует концепцию безопасности, представленную SOP, и позволяет потенциально вредоносным веб-страницам получать доступ к потенциально конфиденциальной информации этого домена.

Если сервер дополнительно устанавливает заголовок `Access-Control-Allow-Credentials: true`, можно получить доступ к аутентифицированным частям веб-приложения.
## Теория
CORS — это механизм безопасности, который позволяет веб-странице из одного домена обращаться к ресурсу с другим доменом (кросс-доменным запросом). Без таких функций, как CORS, веб-сайты ограничиваются доступом к ресурсам одного и того же происхождения через так называемую политику единого происхождения.

Первым шагом в понимании CORS является знание того, как работают некоторые функции безопасности веб-браузеров. По умолчанию веб-браузеры не разрешают AJAX-запросы на сайты, кроме сайта, который вы посещаете. Это называется политикой единого происхождения, и это важная часть модели веб-безопасности. Совместное использование ресурсов между разными источниками (cross-origin resource sharing) — это механизм HTML 5, который дополняет политику единого происхождения для упрощения совместного использования ресурсов домена между различными веб-приложениями.

Спецификация CORS определяет набор заголовков, которые позволяют серверу и браузеру определять, какие запросы для междоменных ресурсов (изображения, таблицы стилей, сценарии, данные и т. д.) разрешены, а какие нет. CORS является техникой для ослабления правила одного источника, позволяя JavaScript на web странице обрабатывать REST API запросы от другого источника.

По своей сути, CORS это защитная оболочка для браузера. Совместное использование ресурсов между разными источниками очень важно в современном мире сложных веб-приложений, и все браузеры поддерживают его. В частности, CORS обычно используется для междоменных AJAX запросов.

Веб приложение проверяет происхождение запроса и на основании Origin либо принимает запрос, либо отвергает его. Если запрос принят, запрашиваемые сервер ответит заголовком Access-Control-Allow-Origin. Этот заголовок будет указывать клиенту с каким происхождением будет разрешен доступ. Принимая во внимание, что Access-Control-Allow-Origin соответствует Origin запроса, браузер разрешит запрос.
### Заголовки
HTTP заголовки относящиеся к CORS:

Заголовки запроса:
+ `Origin`
+ `Access-Control-Request-Method`
+ `Access-Control-Request-Headers`

Заголовки ответа:

+ `Access-Control-Allow-Origin`
+ `Access-Control-Allow-Credentials`
+ `Access-Control-Expose-Headers`
+ `Access-Control-Max-Age`
+ `Access-Control-Allow-Methods`
+ `Access-Control-Allow-Headers`

### Пример уязвимости
Отправим запрос и добавим заголовок `Origin` с произвольным вебсайтом:
```
GET / HTTP/1.1
Host: dev.roads.mos.ru
[…]
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:105.0) Gecko/20100101 Firefox/105.0
Origin: https://seq.team
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: en,en-US;q=0.8,ru;q=0.5,ru-RU;q=0.3
Accept-Encoding: gzip, deflate
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: none
Sec-Fetch-User: ?1
Te: trailers
Connection: close
```
В ответ от сервера можем увидеть, что домен `seq.team` разрешён. Это означает, что CORS натсроен неправильно.
```
HTTP/1.1 200 OK
Content-Type: text/html; charset=utf-8
Connection: close
Server: nginx
Date: Fri, 30 Sep 2022 16:03:59 GMT
Cache-Control: private
Access-Control-Allow-Origin: https://seq.team
Access-Control-Allow-Credentials: true
Access-Control-Allow-Origin: http://10.176.66.11
Access-Control-Allow-Credentials: true
Content-Length: 13284
```

## Демонстрация уязвимости
Чтобы проверить, разрешен ли домен, достаточно отправить заголовок «Origin» в запросе.
Запрос с специальным заголовком Origin: `домен` представлен ниже:
```
запрос к серверу
```
В ответе сервера можно увидеть, что домен `домен` разрешен. Это означает, что CORS настроен неправильно. 

```
ответ сервера
```

## Рекомендации
+ Каждый отдельный домен, которому должен быть разрешен доступ к ресурсам, должен быть добавлен в политику. 
+ Подстановочный знак в политике представляет собой угрозу безопасности. Использование * в качестве значения заголовка Access-Control-Allow-Origin указывает, что данные приложения доступны для JavaScript, работающего в любом другом домене.
+ Необходимо скорректировать настроенную политику в файле /etc/nginx/nginx.conf следующим образом. Заменив значения Домен1-3 на домены Заказчика.
```
add_header Access-Control-Allow-Origin "Домен1";
add_header Access-Control-Allow-Origin "Домен2";
add_header Access-Control-Allow-Origin "Домен3";
```
После добавления изменений необходимо перезапустить NGINX сервер командой:

```
$ sudo service nginx reload #debian/ubuntu
$ systemctl restart nginx #redhat/centos
```


## Дополнтельная литература
```
https://en.wikipedia.org/wiki/Cross-origin_resource_sharing
https://owasp.org/www-community/attacks/CORS_OriginHeaderScrutiny
https://portswigger.net/web-security/cors
```
